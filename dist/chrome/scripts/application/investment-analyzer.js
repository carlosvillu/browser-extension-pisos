!function(){"use strict";var e={16:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.RentalDataAnalyzer=void 0,t.RentalDataAnalyzer=class{logger;propertyExtractor;cacheService;errorHandler;constructor(e,t,r,n){this.logger=e,this.propertyExtractor=t,this.cacheService=r,this.errorHandler=n}async fetchRentalData(e){const t=this.createCacheKey(e);return this.cacheService.get(t)||this.fetchWithRetry(e,t,1)}async fetchWithRetry(e,t,r){const n={operation:"fetchRentalData",url:e};try{this.logger.log(`Fetching rental data (attempt ${r}): ${e}`);const n=await fetch(e,{method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"es-ES,es;q=0.5","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"}});if(!n.ok)throw new Error(`HTTP ${n.status}: Failed to fetch rental data`);const a=await n.text(),s=this.parseRentalDataFromHtml(a);return s&&this.cacheService.set(t,s),s}catch(a){if(this.errorHandler.handleError(a,n),this.errorHandler.shouldRetry(a,r)){const n=this.errorHandler.getRetryDelay(r);return this.logger.log(`Retrying in ${n}ms (attempt ${r+1})`),await this.delay(n),this.fetchWithRetry(e,t,r+1)}return null}}createCacheKey(e){try{const t=new URL(e);return`${t.pathname}${t.search}`}catch{return e}}delay(e){return new Promise((t=>setTimeout(t,e)))}parseRentalDataFromHtml(e){try{const t=(new DOMParser).parseFromString(e,"text/html"),r=this.propertyExtractor.extractPropertiesFromDocument(t);if(0===r.length)return this.logger.log("No rental properties found in response"),null;const n=r.map((e=>e.price)).filter((e=>e>0)).sort(((e,t)=>e-t));if(0===n.length)return this.logger.log("No valid prices found in rental properties"),null;const a=n.reduce(((e,t)=>e+t),0)/n.length,s=n[0],o=n[n.length-1];return this.logger.log(`Rental analysis: ${n.length} properties, avg: ${a}‚Ç¨`),{averagePrice:Math.round(a),minPrice:s,maxPrice:o,sampleSize:n.length,properties:r}}catch(e){return this.logger.error("Error parsing rental data from HTML",e),null}}}},75:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.RobustErrorHandler=void 0,t.RobustErrorHandler=class{logger;maxRetries=3;baseDelay=1e3;errorCounts=new Map;constructor(e){this.logger=e}handleError(e,t){const r=`${t.operation}-${e.name}`,n=this.errorCounts.get(r)||0;this.errorCounts.set(r,n+1),this.logger.error(`Error in ${t.operation}`,{error:e.message,stack:e.stack,context:t,errorCount:n+1}),e.message.includes("fetch")?this.logger.error("Network error detected",{url:t.url,propertyId:t.propertyId}):(e.message.includes("parse")||e.message.includes("DOM"))&&this.logger.error("Parsing error detected",{operation:t.operation,additionalData:t.additionalData})}shouldRetry(e,t){return!(t>=this.maxRetries||!(e.message.includes("fetch")||e.message.includes("network")||e.message.includes("timeout"))&&!(e.message.includes("500")||e.message.includes("502")||e.message.includes("503")||e.message.includes("504")))}getRetryDelay(e){const t=this.baseDelay*Math.pow(2,e);return t+.1*Math.random()*t}getErrorStats(){return Object.fromEntries(this.errorCounts)}clearErrorStats(){this.errorCounts.clear(),this.logger.log("Error statistics cleared")}}},141:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.PropertyBatchProcessor=void 0,t.PropertyBatchProcessor=class{logger;urlGenerator;constructor(e,t){this.logger=e,this.urlGenerator=t}createBatches(e,t){const r=new Map;e.forEach((e=>{const n=this.urlGenerator.generateRentalUrl(t.location,e),a=this.createCacheKey(n,e);r.has(a)||r.set(a,[]),r.get(a).push(e)}));const n=Array.from(r.entries()).map((([e,r])=>{const n=r[0];return{properties:r,rentalUrl:this.urlGenerator.generateRentalUrl(t.location,n),cacheKey:e}}));return this.logger.log(`Created ${n.length} batches from ${e.length} properties`),n}createCacheKey(e,t){try{const r=new URL(e),n=["location","rooms","bathrooms","minSize","maxSize","minPrice","maxPrice"],a=new URLSearchParams;n.forEach((e=>{const t=r.searchParams.get(e);null!==t&&a.set(e,t)}));const s=this.getRoomsGroup(t.rooms||0),o=this.getSizeGroup(t.size||0);return`${r.pathname}?${a.toString()}&rooms_group=${s}&size_group=${o}`}catch(t){return this.logger.error("Error creating cache key",t),e}}getRoomsGroup(e){return e<=1?"1":e<=2?"2":e<=3?"3":"4+"}getSizeGroup(e){return e<=50?"small":e<=80?"medium":e<=120?"large":"xlarge"}}},169:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ProfitabilityCalculator=void 0,t.ProfitabilityCalculator=class{logger;config;DEFAULT_CONFIG={propertyManagementRate:.09,insuranceRate:.002,propertyTaxRate:.007,communityFeesWithGarage:80,communityFeesWithoutGarage:40,vacancyMaintenanceRate:.05};constructor(e,t={}){this.logger=e,this.config=t,this.config={...this.DEFAULT_CONFIG,...t}}calculateProfitability(e,t){const r=t.averagePrice,n=12*r,a=e.price,s=n/a*100,o=this.calculateMonthlyExpenses(e,r),i=n-12*o,l=Math.max(0,i/a*100),{recommendation:c,riskLevel:d}=this.evaluateInvestment(s,l,t.sampleSize);return this.logger.log(`Profitability calculation for ${e.id}: Gross ${s.toFixed(2)}%, Net ${l.toFixed(2)}%`),{propertyId:e.id,purchasePrice:a,estimatedRent:r,grossYield:Math.round(100*s)/100,netYield:Math.round(100*l)/100,monthlyExpenses:o,recommendation:c,riskLevel:d}}calculateMonthlyExpenses(e,t){let r=0;r+=t*this.config.propertyManagementRate;const n=e.price;return r+=n*this.config.insuranceRate/12,r+=n*this.config.propertyTaxRate/12,e.hasGarage||e.floor?.includes("ascensor")?r+=this.config.communityFeesWithGarage:r+=this.config.communityFeesWithoutGarage,r+=t*this.config.vacancyMaintenanceRate,Math.round(r)}evaluateInvestment(e,t,r){let n,a;return n=t>=6?"excellent":t>=4?"good":t>=2?"fair":"poor",a=r<3||e>8||t<1?"high":t>=3&&e<=7?"low":"medium",{recommendation:n,riskLevel:a}}}},516:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.UrlAnalyzer=void 0,t.UrlAnalyzer=class{logger;constructor(e){this.logger=e}analyzeCurrentPage(){const e=new URL(window.location.href);return this.analyzeUrl(e)}analyzeUrl(e){const t=e.pathname,r=e.searchParams;let n=null;t.includes("/venta-viviendas/")?n="venta":t.includes("/alquiler-viviendas/")&&(n="alquiler");const a=this.extractLocationFromUrl(t),s=r.toString().length>0,o={isIdealista:"www.idealista.com"===e.hostname&&(t.includes("/venta-viviendas/")||t.includes("/alquiler-viviendas/")),searchType:n,location:a,hasFilters:s};return this.logger.log("URL Analysis:",o),o}isIdealistaPropertyPage(){const e=window.location.hostname,t=window.location.pathname;return"www.idealista.com"===e&&(t.includes("/venta-viviendas/")||t.includes("/alquiler-viviendas/"))}extractLocationFromUrl(e){const t=e.match(/\/(venta|alquiler)-viviendas\/([^/]+)/);return t?t[2]:null}}},530:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0,t.Logger=class{context;constructor(e){this.context=e}log(e,t){const r=`[${(new Date).toISOString()}][${this.context}]`;t?console.log(`${r} ${e}`,t):console.log(`${r} ${e}`)}error(e,t){const r=`[${(new Date).toISOString()}][${this.context}][ERROR]`;t?console.error(`${r} ${e}`,t):console.error(`${r} ${e}`)}}},660:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.RentalDataCacheService=void 0,t.RentalDataCacheService=class{logger;cache=new Map;defaultTTL=6e5;constructor(e){this.logger=e,setInterval((()=>this.cleanup()),3e5)}get(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),this.logger.log(`Cache entry expired for key: ${e}`),null):(this.logger.log(`Cache hit for key: ${e}`),t.data):null}set(e,t,r=this.defaultTTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r}),this.logger.log(`Cached data for key: ${e} (TTL: ${r}ms)`)}clear(){this.cache.clear(),this.logger.log("Cache cleared")}cleanup(){const e=Date.now(),t=this.cache.size;for(const[t,r]of this.cache.entries())e-r.timestamp>r.ttl&&this.cache.delete(t);const r=t-this.cache.size;r>0&&this.logger.log(`Cleaned up ${r} expired cache entries`)}}},677:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.InvestmentUIRenderer=void 0,t.InvestmentUIRenderer=class{logger;constructor(e){this.logger=e}renderBadge(e,t){const r=this.findPropertyElement(e.id);if(!r)return void this.logger.error(`Property element not found for ID: ${e.id}`);this.removeBadge(e);const n=this.createAnalysisButton(e,t),a=r.querySelector(".item-description");a?(a.parentNode?.insertBefore(n,a.nextSibling),this.logger.log(`Investment analysis button rendered for property ${e.id}: ${t.recommendation}`)):this.logger.error(`Description container not found for property ${e.id}`)}renderLoadingBadge(e){const t=this.findPropertyElement(e.id);if(!t)return;this.removeBadge(e);const r=document.createElement("div");r.className="investment-badge investment-badge--loading",r.setAttribute("data-property-id",e.id),r.textContent="Analyzing...";const n=t.querySelector(".item-multimedia");n&&(n.appendChild(r),this.logger.log(`Loading badge rendered for property ${e.id}`))}renderNoDataBadge(e){const t=this.findPropertyElement(e.id);if(!t)return;this.removeBadge(e);const r=document.createElement("div");r.className="investment-badge investment-badge--no-data",r.setAttribute("data-property-id",e.id),r.innerHTML='\n      <div class="investment-badge__content">\n        <div class="investment-badge__icon">üìä</div>\n        <div class="investment-badge__text">Sin datos de alquiler</div>\n      </div>\n    ';const n=t.querySelector(".item-multimedia");n&&(n.appendChild(r),this.logger.log(`No data badge rendered for property ${e.id}`))}renderErrorBadge(e){const t=this.findPropertyElement(e.id);if(!t)return;this.removeBadge(e);const r=document.createElement("div");r.className="investment-badge investment-badge--error",r.setAttribute("data-property-id",e.id),r.innerHTML='\n      <div class="investment-badge__content">\n        <div class="investment-badge__icon">‚ö†Ô∏è</div>\n        <div class="investment-badge__text">Error en an√°lisis</div>\n      </div>\n    ';const n=t.querySelector(".item-multimedia");n&&(n.appendChild(r),this.logger.log(`Error badge rendered for property ${e.id}`))}removeBadge(e){document.querySelectorAll(`[data-property-id="${e.id}"]`).forEach((e=>e.remove()))}findPropertyElement(e){return document.querySelector(`article.item[data-element-id="${e}"]`)}createAnalysisButton(e,t){const r=document.createElement("div");r.className="investment-analysis-container",r.setAttribute("data-property-id",t.propertyId);const n=document.createElement("button");return n.className=`investment-analysis-button investment-analysis-button--${t.recommendation}`,n.innerHTML=`\n      <div class="investment-analysis-button__content">\n        <div class="investment-analysis-button__yield">\n          <span class="investment-analysis-button__yield-label">Rentabilidad Neta:</span>\n          <span class="investment-analysis-button__yield-value">${t.netYield}%</span>\n        </div>\n        <div class="investment-analysis-button__recommendation">\n          ${this.getRecommendationText(t.recommendation)}\n        </div>\n        <div class="investment-analysis-button__icon">üìä</div>\n      </div>\n    `,n.addEventListener("click",(r=>{r.preventDefault(),r.stopPropagation(),this.openAnalysisModal(e,t),this.logger.log(`Investment modal opened for property ${e.id}`)})),r.appendChild(n),r}openAnalysisModal(e,t){new r(this.logger).openModal(e,t)}getRecommendationText(e){switch(e){case"excellent":return"EXCELENTE INVERSI√ìN";case"good":return"BUENA INVERSI√ìN";case"fair":return"INVERSI√ìN REGULAR";case"poor":return"MALA INVERSI√ìN";default:return"DESCONOCIDO"}}};class r{logger;constructor(e){this.logger=e}openModal(e,t){const r=document.querySelector(".investment-modal-overlay");r&&r.remove();const n=document.createElement("div");n.className="investment-modal-overlay";const a=document.createElement("div");a.className="investment-modal",a.innerHTML=this.createModalContent(e,t),n.appendChild(a),document.body.appendChild(n),this.addEventListeners(a,n)}createModalContent(e,t){return`\n      <div class="investment-modal__header">\n        <h3 class="investment-modal__title">An√°lisis de Inversi√≥n</h3>\n        <button class="investment-modal__close">√ó</button>\n      </div>\n      \n      <div class="investment-modal__content">\n        <div class="investment-modal__property-info">\n          <h4>${e.title}</h4>\n          <p class="investment-modal__property-details">\n            ${e.rooms?e.rooms+" hab.":""} \n            ${e.size?e.size+"m¬≤":""}\n            ${e.floor?" ‚Ä¢ "+e.floor:""}\n          </p>\n        </div>\n\n        <div class="investment-modal__analysis">\n          <div class="investment-modal__recommendation investment-modal__recommendation--${t.recommendation}">\n            <div class="investment-modal__recommendation-text">\n              ${this.getRecommendationText(t.recommendation)}\n            </div>\n            <div class="investment-modal__recommendation-yield">\n              Rentabilidad Neta: ${t.netYield}%\n            </div>\n          </div>\n\n          <div class="investment-modal__details-grid">\n            <div class="investment-modal__detail-item">\n              <span class="investment-modal__label">Precio de compra</span>\n              <span class="investment-modal__value">${t.purchasePrice.toLocaleString()}‚Ç¨</span>\n            </div>\n            \n            <div class="investment-modal__detail-item">\n              <span class="investment-modal__label">Alquiler estimado mensual</span>\n              <span class="investment-modal__value">${t.estimatedRent.toLocaleString()}‚Ç¨</span>\n            </div>\n            \n            <div class="investment-modal__detail-item">\n              <span class="investment-modal__label">Gastos mensuales estimados</span>\n              <span class="investment-modal__value">${t.monthlyExpenses.toLocaleString()}‚Ç¨</span>\n            </div>\n            \n            <div class="investment-modal__divider"></div>\n            \n            <div class="investment-modal__detail-item">\n              <span class="investment-modal__label">Rentabilidad bruta anual</span>\n              <span class="investment-modal__value">${t.grossYield}%</span>\n            </div>\n            \n            <div class="investment-modal__detail-item investment-modal__detail-item--highlight">\n              <span class="investment-modal__label">Rentabilidad neta anual</span>\n              <span class="investment-modal__value">${t.netYield}%</span>\n            </div>\n            \n            <div class="investment-modal__risk investment-modal__risk--${t.riskLevel}">\n              <div class="investment-modal__risk-dot"></div>\n              <span>Nivel de riesgo: ${t.riskLevel.toUpperCase()}</span>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}addEventListeners(e,t){const r=e.querySelector(".investment-modal__close");r?.addEventListener("click",(()=>{t.remove()})),t.addEventListener("click",(e=>{e.target===t&&t.remove()}));const n=e=>{"Escape"===e.key&&(t.remove(),document.removeEventListener("keydown",n))};document.addEventListener("keydown",n)}getRecommendationText(e){switch(e){case"excellent":return"EXCELENTE INVERSI√ìN";case"good":return"BUENA INVERSI√ìN";case"fair":return"INVERSI√ìN REGULAR";case"poor":return"MALA INVERSI√ìN";default:return"DESCONOCIDO"}}}},710:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.IntersectionLazyLoader=void 0,t.IntersectionLazyLoader=class{logger;observer=null;callbacks=new Map;processedElements=new Set;constructor(e){this.logger=e}observeElements(e,t,r={}){this.observer||this.createObserver(r),e.forEach((e=>{this.processedElements.has(e)||(this.callbacks.set(e,(()=>t(e))),this.observer.observe(e),this.logger.log(`Started observing element for lazy loading: ${e.tagName}`))}))}unobserve(e){this.observer&&(this.observer.unobserve(e),this.callbacks.delete(e),this.processedElements.delete(e))}disconnect(){this.observer&&(this.observer.disconnect(),this.callbacks.clear(),this.processedElements.clear(),this.observer=null,this.logger.log("Lazy loader disconnected"))}createObserver(e){const t={rootMargin:e.rootMargin||"50px",threshold:e.threshold||.1};this.observer=new IntersectionObserver((t=>{t.forEach((t=>{if(t.isIntersecting&&!this.processedElements.has(t.target)){this.processedElements.add(t.target);const r=this.callbacks.get(t.target);if(r){const n=e.delay||100;setTimeout((()=>{r(),this.unobserve(t.target)}),n)}}}))}),t),this.logger.log("Intersection observer created for lazy loading",t)}}},841:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CrossReferenceUrlGenerator=void 0,t.CrossReferenceUrlGenerator=class{logger;constructor(e){this.logger=e}generateRentalUrl(e,t){return this.buildUrl("https://www.idealista.com/alquiler-viviendas",e,t)}generateSaleUrl(e,t){return this.buildUrl("https://www.idealista.com/venta-viviendas",e,t)}buildUrl(e,t,r){if(!t)return this.logger.error("No location provided for URL generation"),`${e}/`;let n=`${e}/${t}/`;const a=new URLSearchParams;if(r.rooms&&r.rooms>0&&a.append("habitaciones",r.rooms.toString()),r.size&&r.size>0){const e=Math.max(1,r.size-20),t=r.size+20;a.append("superficie",`${e}-${t}`)}const s=a.toString();return s&&(n+=`?${s}`),n}}},922:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.PropertyExtractor=void 0,t.PropertyExtractor=class{logger;constructor(e){this.logger=e}extractPropertiesFromPage(){const e=[],t=document.querySelectorAll("article.item[data-element-id]");return this.logger.log(`Found ${t.length} property elements on page`),t.forEach((t=>{try{const r=this.extractPropertyData(t);r&&e.push(r)}catch(e){this.logger.error("Error extracting property data",e)}})),e}extractPropertiesFromDocument(e){const t=[];return e.querySelectorAll("article.item[data-element-id]").forEach((e=>{try{const r=this.extractPropertyDataFromElement(e);r&&t.push(r)}catch(e){this.logger.error("Error extracting property data from element",e)}})),t}extractPropertyData(e){return this.extractPropertyDataFromElement(e)}extractPropertyDataFromElement(e){const t=e.getAttribute("data-element-id");if(!t)return null;const r=e.querySelector(".item-price"),n=r?.textContent?.replace(/[‚Ç¨\s]/g,"").replace(".","")||"0",a=parseInt(n,10)||0,s=e.querySelector(".item-link"),o=s?.textContent?.trim()||"",i=s?.href||"",l=e.querySelectorAll(".item-detail");let c=null,d=null,m=null;l.forEach((e=>{const t=e.textContent?.trim()||"";if(t.includes("hab.")){const e=t.match(/(\d+)\s*hab\./);c=e?parseInt(e[1],10):null}else if(t.includes("m¬≤")){const e=t.match(/(\d+)\s*m¬≤/);d=e?parseInt(e[1],10):null}else(t.includes("Planta")||t.includes("Bajo"))&&(m=t)}));const g=!!e.querySelector(".item-parking"),u=e.querySelector(".item-description .ellipsis"),h=u?.textContent?.trim()||"",p=e.querySelectorAll(".listing-tags"),v=Array.from(p).map((e=>e.textContent?.trim()||"")),y=this.extractLocationFromTitle(o);return{id:t,title:o,price:a,rooms:c,size:d,floor:m,hasGarage:g,description:h,url:i,tags:v,location:y}}extractLocationFromTitle(e){const t=e.split(",");return t.length>=2?t[t.length-2].trim():""}}}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}r(530),r(516),r(922),r(16),r(169),r(841),r(677),r(660),r(75),r(141),r(710)}();