!function(){"use strict";var e={16:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.RentalDataAnalyzer=void 0,t.RentalDataAnalyzer=class{logger;propertyExtractor;cacheService;errorHandler;constructor(e,t,n,r){this.logger=e,this.propertyExtractor=t,this.cacheService=n,this.errorHandler=r}async fetchRentalData(e){const t=this.createCacheKey(e);return await this.cacheService.get(t)||this.fetchWithRetry(e,t,1)}async fetchWithRetry(e,t,n){const r={operation:"fetchRentalData",url:e};try{this.logger.log(`Fetching rental data (attempt ${n}): ${e}`);const r=await fetch(e,{method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"es-ES,es;q=0.5","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"}});if(!r.ok)throw new Error(`HTTP ${r.status}: Failed to fetch rental data`);const o=await r.text(),s=this.parseRentalDataFromHtml(o);return s&&await this.cacheService.set(t,s),s}catch(o){if(this.errorHandler.handleError(o,r),this.errorHandler.shouldRetry(o,n)){const r=this.errorHandler.getRetryDelay(n);return this.logger.log(`Retrying in ${r}ms (attempt ${n+1})`),await this.delay(r),this.fetchWithRetry(e,t,n+1)}return null}}createCacheKey(e){try{const t=new URL(e);return`${t.pathname}${t.search}`}catch{return e}}delay(e){return new Promise((t=>setTimeout(t,e)))}parseRentalDataFromHtml(e){try{const t=(new DOMParser).parseFromString(e,"text/html"),n=this.propertyExtractor.extractPropertiesFromDocument(t);if(0===n.length)return this.logger.log("No rental properties found in response"),null;const r=n.map((e=>e.price)).filter((e=>e>0)).sort(((e,t)=>e-t));if(0===r.length)return this.logger.log("No valid prices found in rental properties"),null;const o=r.reduce(((e,t)=>e+t),0)/r.length,s=r[0],i=r[r.length-1];return this.logger.log(`Rental analysis: ${r.length} properties, avg: ${o}€`),{averagePrice:Math.round(o),minPrice:s,maxPrice:i,sampleSize:r.length,properties:n}}catch(e){return this.logger.error("Error parsing rental data from HTML",e),null}}}},47:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.IntersectionSimpleLazyLoader=void 0,t.IntersectionSimpleLazyLoader=class{logger;observer=null;processedElements=new Set;constructor(e){this.logger=e}observeElements(e,t){this.observer||(this.observer=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&!this.processedElements.has(e.target)&&(this.processedElements.add(e.target),t(e.target),this.observer.unobserve(e.target))}))}),{rootMargin:"100px",threshold:.1})),e.forEach((e=>{this.processedElements.has(e)||this.observer.observe(e)}))}disconnect(){this.observer&&(this.observer.disconnect(),this.processedElements.clear(),this.observer=null)}}},75:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.RobustErrorHandler=void 0,t.RobustErrorHandler=class{logger;maxRetries=3;baseDelay=1e3;errorCounts=new Map;constructor(e){this.logger=e}handleError(e,t){const n=`${t.operation}-${e.name}`,r=this.errorCounts.get(n)||0;this.errorCounts.set(n,r+1),this.logger.error(`Error in ${t.operation}`,{error:e.message,stack:e.stack,context:t,errorCount:r+1}),e.message.includes("fetch")?this.logger.error("Network error detected",{url:t.url,propertyId:t.propertyId}):(e.message.includes("parse")||e.message.includes("DOM"))&&this.logger.error("Parsing error detected",{operation:t.operation,additionalData:t.additionalData})}shouldRetry(e,t){return!(t>=this.maxRetries||!(e.message.includes("fetch")||e.message.includes("network")||e.message.includes("timeout"))&&!(e.message.includes("500")||e.message.includes("502")||e.message.includes("503")||e.message.includes("504")))}getRetryDelay(e){const t=this.baseDelay*Math.pow(2,e);return t+.1*Math.random()*t}getErrorStats(){return Object.fromEntries(this.errorCounts)}clearErrorStats(){this.errorCounts.clear(),this.logger.log("Error statistics cleared")}}},169:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.ProfitabilityCalculator=void 0;const r=n(294);t.ProfitabilityCalculator=class{logger;config;DEFAULT_CONFIG={propertyManagementRate:.09,insuranceRate:.002,propertyTaxRate:.007,communityFeesWithGarage:80,communityFeesWithoutGarage:40,vacancyMaintenanceRate:.05};configService;userConfig;constructor(e,t={}){this.logger=e,this.config=t,this.config={...this.DEFAULT_CONFIG,...t},this.configService=new r.ConfigService}async calculateProfitability(e,t){this.userConfig||(this.userConfig=await this.configService.getConfig());const n=this.userConfig.expenseConfig,r=t.averagePrice,o=12*r,s=e.price,i=o/s*100,a=this.calculateMonthlyExpenses(e,r,n),l=o-12*a,c=Math.max(0,l/s*100),{recommendation:d,riskLevel:m}=this.evaluateInvestment(i,c,t.sampleSize);return this.logger.log(`Profitability calculation for ${e.id}: Gross ${i.toFixed(2)}%, Net ${c.toFixed(2)}%`),{propertyId:e.id,purchasePrice:s,estimatedRent:r,grossYield:Math.round(100*i)/100,netYield:Math.round(100*c)/100,monthlyExpenses:a,recommendation:d,riskLevel:m}}calculateMonthlyExpenses(e,t,n){let r=0;return r+=n.propertyManagementMonthly||150,r+=n.insuranceMonthly||50,r+=n.propertyTaxMonthly||100,r+=n.communityFees||60,r+=t*(n.vacancyMaintenanceRate||.05),r+=t*(n.maintenanceContingencyRate||.01),Math.round(r)}evaluateInvestment(e,t,n){let r,o;const s=this.userConfig?.profitabilityThresholds||{excellent:6,good:4,fair:2};return r=t>=s.excellent?"excellent":t>=s.good?"good":t>=s.fair?"fair":"poor",o=n<3||e>8||t<1?"high":t>=3&&e<=7?"low":"medium",{recommendation:r,riskLevel:o}}}},294:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigService=void 0;class n{static STORAGE_KEY="investmentAnalysisConfig";static DEFAULT_CONFIG={expenseConfig:{propertyManagementMonthly:150,insuranceMonthly:50,propertyTaxMonthly:100,communityFees:60,vacancyMaintenanceRate:.05,maintenanceContingencyRate:.01},mortgageConfig:{loanToValueRatio:.8,managementFeesRate:.1,interestRate:2.45},profitabilityThresholds:{excellent:6,good:4,fair:2},displayOptions:{showBadges:!0,showModal:!0,showLoadingStates:!0}};async getConfig(){try{const e=(await chrome.storage.sync.get(n.STORAGE_KEY))[n.STORAGE_KEY];if(!e)return n.DEFAULT_CONFIG;const t=this.migrateOldConfig(e);return{...n.DEFAULT_CONFIG,...t}}catch(e){return console.error("Error loading config:",e),n.DEFAULT_CONFIG}}migrateOldConfig(e){if(e.expenseConfig&&e.expenseConfig.communityFeesWithGarage&&!e.expenseConfig.communityFees){const t=Math.round(((e.expenseConfig.communityFeesWithGarage||80)+(e.expenseConfig.communityFeesWithoutGarage||40))/2);e.expenseConfig.communityFees=t,delete e.expenseConfig.communityFeesWithGarage,delete e.expenseConfig.communityFeesWithoutGarage}return e}async updateConfig(e){try{const t={...await this.getConfig(),...e};await chrome.storage.sync.set({[n.STORAGE_KEY]:t})}catch(e){throw console.error("Error saving config:",e),e}}async resetToDefaults(){try{await chrome.storage.sync.set({[n.STORAGE_KEY]:n.DEFAULT_CONFIG})}catch(e){throw console.error("Error resetting config:",e),e}}}t.ConfigService=n},420:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ContentCacheService=void 0,t.ContentCacheService=class{logger;constructor(e){this.logger=e}async get(e){try{const t=await chrome.runtime.sendMessage({type:"CACHE_GET",key:e});if(!t.success)throw new Error(t.error);return t.data}catch(t){return this.logger.error(`Error getting cache for key ${e}:`,t),null}}async set(e,t,n){try{const r=await chrome.runtime.sendMessage({type:"CACHE_SET",key:e,data:t,ttl:n});if(!r.success)throw new Error(r.error)}catch(t){this.logger.error(`Error setting cache for key ${e}:`,t)}}async clear(){try{const e=await chrome.runtime.sendMessage({type:"CACHE_CLEAR"});if(!e.success)throw new Error(e.error)}catch(e){this.logger.error("Error clearing cache:",e)}}async cleanup(){try{const e=await chrome.runtime.sendMessage({type:"CACHE_CLEANUP"});if(!e.success)throw new Error(e.error)}catch(e){this.logger.error("Error during cache cleanup:",e)}}}},516:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.UrlAnalyzer=void 0,t.UrlAnalyzer=class{logger;constructor(e){this.logger=e}analyzeCurrentPage(){const e=new URL(window.location.href);return this.analyzeUrl(e)}analyzeUrl(e){const t=e.pathname,n=e.searchParams;let r=null;t.includes("/venta-viviendas/")?r="venta":t.includes("/alquiler-viviendas/")&&(r="alquiler");const o=this.extractLocationFromUrl(t),s=n.toString().length>0,i={isIdealista:"www.idealista.com"===e.hostname&&(t.includes("/venta-viviendas/")||t.includes("/alquiler-viviendas/")),searchType:r,location:o,hasFilters:s};return this.logger.log("URL Analysis:",i),i}isIdealistaPropertyPage(){const e=window.location.hostname,t=window.location.pathname;return"www.idealista.com"===e&&(t.includes("/venta-viviendas/")||t.includes("/alquiler-viviendas/"))}extractLocationFromUrl(e){const t=e.match(/\/(venta|alquiler)-viviendas\/([^/]+)/);return t?t[2]:null}}},530:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0,t.Logger=class{context;constructor(e){this.context=e}log(e,t){const n=`[${(new Date).toISOString()}][${this.context}]`;t?console.log(`${n} ${e}`,t):console.log(`${n} ${e}`)}error(e,t){const n=`[${(new Date).toISOString()}][${this.context}][ERROR]`;t?console.error(`${n} ${e}`,t):console.error(`${n} ${e}`)}}},677:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.InvestmentUIRenderer=void 0;const r=n(294);t.InvestmentUIRenderer=class{logger;configService;userConfig;constructor(e){this.logger=e,this.configService=new r.ConfigService}async renderBadge(e,t){if(this.userConfig||(this.userConfig=await this.configService.getConfig()),!this.userConfig.displayOptions.showBadges)return;const n=this.findPropertyElement(e.id);if(!n)return void this.logger.error(`Property element not found for ID: ${e.id}`);this.removeBadge(e);const r=this.createAnalysisButton(e,t),o=n.querySelector(".item-description");o?(o.parentNode?.insertBefore(r,o.nextSibling),this.logger.log(`Investment analysis button rendered for property ${e.id}: ${t.recommendation}`)):this.logger.error(`Description container not found for property ${e.id}`)}async renderLoadingBadge(e){if(this.userConfig||(this.userConfig=await this.configService.getConfig()),!this.userConfig.displayOptions.showLoadingStates)return;const t=this.findPropertyElement(e.id);if(!t)return;this.removeBadge(e);const n=document.createElement("div");n.className="investment-badge investment-badge--loading",n.setAttribute("data-property-id",e.id),n.textContent="Analyzing...";const r=t.querySelector(".item-multimedia");r&&(r.appendChild(n),this.logger.log(`Loading badge rendered for property ${e.id}`))}renderNoDataBadge(e){const t=this.findPropertyElement(e.id);if(!t)return;this.removeBadge(e);const n=document.createElement("div");n.className="investment-badge investment-badge--no-data",n.setAttribute("data-property-id",e.id),n.innerHTML='\n      <div class="investment-badge__content">\n        <div class="investment-badge__icon">📊</div>\n        <div class="investment-badge__text">Sin datos de alquiler</div>\n      </div>\n    ';const r=t.querySelector(".item-multimedia");r&&(r.appendChild(n),this.logger.log(`No data badge rendered for property ${e.id}`))}renderErrorBadge(e){const t=this.findPropertyElement(e.id);if(!t)return;this.removeBadge(e);const n=document.createElement("div");n.className="investment-badge investment-badge--error",n.setAttribute("data-property-id",e.id),n.innerHTML='\n      <div class="investment-badge__content">\n        <div class="investment-badge__icon">⚠️</div>\n        <div class="investment-badge__text">Error en análisis</div>\n      </div>\n    ';const r=t.querySelector(".item-multimedia");r&&(r.appendChild(n),this.logger.log(`Error badge rendered for property ${e.id}`))}removeBadge(e){document.querySelectorAll(`[data-property-id="${e.id}"]`).forEach((e=>e.remove()))}findPropertyElement(e){return document.querySelector(`article.item[data-element-id="${e}"]`)}createAnalysisButton(e,t){const n=document.createElement("div");n.className="investment-analysis-container",n.setAttribute("data-property-id",t.propertyId);const r=document.createElement("button");return r.className=`investment-analysis-button investment-analysis-button--${t.recommendation}`,r.innerHTML=`\n      <div class="investment-analysis-button__content">\n        <div class="investment-analysis-button__yield">\n          <span class="investment-analysis-button__yield-label">Rentabilidad Neta:</span>\n          <span class="investment-analysis-button__yield-value">${t.netYield}%</span>\n        </div>\n        <div class="investment-analysis-button__recommendation">\n          ${this.getRecommendationText(t.recommendation)}\n        </div>\n        <div class="investment-analysis-button__icon">📊</div>\n      </div>\n    `,r.addEventListener("click",(async n=>{n.preventDefault(),n.stopPropagation(),this.userConfig||(this.userConfig=await this.configService.getConfig()),this.userConfig.displayOptions.showModal&&(this.openAnalysisModal(e,t),this.logger.log(`Investment modal opened for property ${e.id}`))})),n.appendChild(r),n}openAnalysisModal(e,t){new o(this.logger).openModal(e,t)}getRecommendationText(e){switch(e){case"excellent":return"EXCELENTE INVERSIÓN";case"good":return"BUENA INVERSIÓN";case"fair":return"INVERSIÓN REGULAR";case"poor":return"MALA INVERSIÓN";default:return"DESCONOCIDO"}}};class o{logger;constructor(e){this.logger=e}openModal(e,t){const n=document.querySelector(".investment-modal-overlay");n&&n.remove();const r=document.createElement("div");r.className="investment-modal-overlay";const o=document.createElement("div");o.className="investment-modal",o.innerHTML=this.createModalContent(e,t),r.appendChild(o),document.body.appendChild(r),this.addEventListeners(o,r)}createModalContent(e,t){return`\n      <div class="investment-modal__header">\n        <h3 class="investment-modal__title">Análisis de Inversión</h3>\n        <button class="investment-modal__close">×</button>\n      </div>\n      \n      <div class="investment-modal__content">\n        <div class="investment-modal__property-info">\n          <h4>${e.title}</h4>\n          <p class="investment-modal__property-details">\n            ${e.rooms?e.rooms+" hab.":""} \n            ${e.size?e.size+"m²":""}\n            ${e.floor?" • "+e.floor:""}\n          </p>\n        </div>\n\n        <div class="investment-modal__analysis">\n          <div class="investment-modal__recommendation investment-modal__recommendation--${t.recommendation}">\n            <div class="investment-modal__recommendation-text">\n              ${this.getRecommendationText(t.recommendation)}\n            </div>\n            <div class="investment-modal__recommendation-yield">\n              Rentabilidad Neta: ${t.netYield}%\n            </div>\n          </div>\n\n          <div class="investment-modal__details-grid">\n            <div class="investment-modal__detail-item">\n              <span class="investment-modal__label">Precio de compra</span>\n              <span class="investment-modal__value">${t.purchasePrice.toLocaleString()}€</span>\n            </div>\n            \n            <div class="investment-modal__detail-item">\n              <span class="investment-modal__label">Alquiler estimado mensual</span>\n              <span class="investment-modal__value">${t.estimatedRent.toLocaleString()}€</span>\n            </div>\n            \n            <div class="investment-modal__detail-item">\n              <span class="investment-modal__label">Gastos mensuales estimados</span>\n              <span class="investment-modal__value">${t.monthlyExpenses.toLocaleString()}€</span>\n            </div>\n            \n            <div class="investment-modal__divider"></div>\n            \n            <div class="investment-modal__detail-item">\n              <span class="investment-modal__label">Rentabilidad bruta anual</span>\n              <span class="investment-modal__value">${t.grossYield}%</span>\n            </div>\n            \n            <div class="investment-modal__detail-item investment-modal__detail-item--highlight">\n              <span class="investment-modal__label">Rentabilidad neta anual</span>\n              <span class="investment-modal__value">${t.netYield}%</span>\n            </div>\n            \n            <div class="investment-modal__risk investment-modal__risk--${t.riskLevel}">\n              <div class="investment-modal__risk-dot"></div>\n              <span>Nivel de riesgo: ${t.riskLevel.toUpperCase()}</span>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}addEventListeners(e,t){const n=e.querySelector(".investment-modal__close");n?.addEventListener("click",(()=>{t.remove()})),t.addEventListener("click",(e=>{e.target===t&&t.remove()}));const r=e=>{"Escape"===e.key&&(t.remove(),document.removeEventListener("keydown",r))};document.addEventListener("keydown",r)}getRecommendationText(e){switch(e){case"excellent":return"EXCELENTE INVERSIÓN";case"good":return"BUENA INVERSIÓN";case"fair":return"INVERSIÓN REGULAR";case"poor":return"MALA INVERSIÓN";default:return"DESCONOCIDO"}}}},841:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CrossReferenceUrlGenerator=void 0,t.CrossReferenceUrlGenerator=class{logger;constructor(e){this.logger=e}generateRentalUrl(e,t){return this.buildUrl("https://www.idealista.com/alquiler-viviendas",e,t)}generateSaleUrl(e,t){return this.buildUrl("https://www.idealista.com/venta-viviendas",e,t)}buildUrl(e,t,n){if(!t)return this.logger.error("No location provided for URL generation"),`${e}/`;let r=`${e}/${t}/`;const o=new URLSearchParams;if(n.rooms&&n.rooms>0&&o.append("habitaciones",n.rooms.toString()),n.size&&n.size>0){const e=Math.max(1,n.size-20),t=n.size+20;o.append("superficie",`${e}-${t}`)}const s=o.toString();return s&&(r+=`?${s}`),r}}},922:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.PropertyExtractor=void 0,t.PropertyExtractor=class{logger;constructor(e){this.logger=e}extractPropertiesFromPage(){const e=[],t=document.querySelectorAll("article.item[data-element-id]");return this.logger.log(`Found ${t.length} property elements on page`),t.forEach((t=>{try{const n=this.extractPropertyData(t);n&&e.push(n)}catch(e){this.logger.error("Error extracting property data",e)}})),e}extractPropertiesFromDocument(e){const t=[];return e.querySelectorAll("article.item[data-element-id]").forEach((e=>{try{const n=this.extractPropertyDataFromElement(e);n&&t.push(n)}catch(e){this.logger.error("Error extracting property data from element",e)}})),t}extractPropertyData(e){return this.extractPropertyDataFromElement(e)}extractPropertyDataFromElement(e){const t=e.getAttribute("data-element-id");if(!t)return null;const n=e.querySelector(".item-price"),r=n?.textContent?.replace(/[€\s]/g,"").replace(".","")||"0",o=parseInt(r,10)||0,s=e.querySelector(".item-link"),i=s?.textContent?.trim()||"",a=s?.href||"",l=e.querySelectorAll(".item-detail");let c=null,d=null,m=null;l.forEach((e=>{const t=e.textContent?.trim()||"";if(t.includes("hab.")){const e=t.match(/(\d+)\s*hab\./);c=e?parseInt(e[1],10):null}else if(t.includes("m²")){const e=t.match(/(\d+)\s*m²/);d=e?parseInt(e[1],10):null}else(t.includes("Planta")||t.includes("Bajo"))&&(m=t)}));const g=!!e.querySelector(".item-parking"),u=e.querySelector(".item-description .ellipsis"),h=u?.textContent?.trim()||"",p=e.querySelectorAll(".listing-tags"),v=Array.from(p).map((e=>e.textContent?.trim()||"")),y=this.extractLocationFromTitle(i);return{id:t,title:i,price:o,rooms:c,size:d,floor:m,hasGarage:g,description:h,url:a,tags:v,location:y}}extractLocationFromTitle(e){const t=e.split(",");return t.length>=2?t[t.length-2].trim():""}}}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,n),s.exports}n(530),n(516),n(922),n(16),n(169),n(841),n(677),n(420),n(75),n(47)}();